name: Xiaozhi AI Music Service

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
  schedule:
    # æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡ï¼Œä¿æŒæœåŠ¡æ´»è·ƒ
    - cron: '0 */4 * * *'

jobs:
  run-music-service:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4å°æ—¶ï¼Œæ¥è¿‘GitHub Actionsé™åˆ¶
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install mcp fastmcp requests python-dotenv

    - name: Setup environment
      env:
        MCP_WSS_TOKEN: ${{ secrets.MCP_WSS_TOKEN }}
        MUSIC_API_KEY: ${{ secrets.MUSIC_API_KEY }}
      run: |
        echo "âœ… ç¯å¢ƒå˜é‡å·²è®¾ç½®"
        echo "MCP Token: ${MCP_WSS_TOKEN:0:10}..."
        if [ -n "$MUSIC_API_KEY" ]; then
          echo "ğŸµ éŸ³ä¹APIå¯†é’¥å·²é…ç½®"
        else
          echo "âš ï¸ éŸ³ä¹APIå¯†é’¥æœªé…ç½®ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™"
        fi

    - name: Start Xiaozhi Music Service
      env:
        MCP_WSS_TOKEN: ${{ secrets.MCP_WSS_TOKEN }}
        MUSIC_API_KEY: ${{ secrets.MUSIC_API_KEY }}
      run: |
        echo "ğŸš€ å¯åŠ¨å°æ™ºAIéŸ³ä¹æœåŠ¡..."
        echo "æœåŠ¡å°†è¿è¡Œ3.5å°æ—¶..."
        
        # å¯åŠ¨æœåŠ¡
        nohup python music_player_for_xiaozhi.py > xiaozhi_music.log 2>&1 &
        echo $! > service.pid
        
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
        if ps -p $(cat service.pid) > /dev/null; then
          echo "âœ… éŸ³ä¹æœåŠ¡å·²å¯åŠ¨å¹¶è¿æ¥åˆ°å°æ™ºAI"
          echo "=== æœåŠ¡æ—¥å¿—å‰20è¡Œ ==="
          head -20 xiaozhi_music.log
        else
          echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
          echo "=== é”™è¯¯æ—¥å¿— ==="
          cat xiaozhi_music.log
          exit 1
        fi

    - name: Monitor Service
      env:
        MCP_WSS_TOKEN: ${{ secrets.MCP_WSS_TOKEN }}
        MUSIC_API_KEY: ${{ secrets.MUSIC_API_KEY }}
      run: |
        echo "ğŸ“Š æœåŠ¡ç›‘æ§ä¸­..."
        echo "å¼€å§‹æ—¶é—´: $(date)"
        
        # ç›‘æ§3.5å°æ—¶
        for i in {1..210}; do
          echo "[$i/210] æœåŠ¡è¿è¡Œä¸­... $(date)"
          
          # æ£€æŸ¥è¿›ç¨‹
          if ! ps -p $(cat service.pid) > /dev/null; then
            echo "âŒ æœåŠ¡è¿›ç¨‹å·²åœæ­¢"
            echo "=== æœ€åæ—¥å¿— ==="
            tail -50 xiaozhi_music.log
            exit 1
          fi
          
          # æ¯åˆ†é’Ÿè®°å½•çŠ¶æ€
          if [ $((i % 5)) -eq 0 ]; then
            echo "=== æœ€è¿‘æ—¥å¿— ==="
            tail -5 xiaozhi_music.log
          fi
          
          sleep 60
        done
        
        echo "â° è¿è¡Œæ—¶é—´ç»“æŸ"

    - name: Stop Service
      if: always()
      run: |
        echo "ğŸ›‘ åœæ­¢æœåŠ¡..."
        if [ -f service.pid ]; then
          kill $(cat service.pid) 2>/dev/null || true
          rm -f service.pid
        fi
        echo "âœ… æœåŠ¡å·²åœæ­¢"

    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: xiaozhi-music-logs
        path: |
          xiaozhi_music.log
        retention-days: 7

    - name: Service Report
      if: always()
      run: |
        echo "ğŸ“‹ æœåŠ¡è¿è¡ŒæŠ¥å‘Š"
        echo "========================"
        if [ -f xiaozhi_music.log ]; then
          echo "ğŸ“Š æœ€åçŠ¶æ€:"
          tail -10 xiaozhi_music.log | grep -E "(INFO|ERROR|CRITICAL)" || echo "æ— çŠ¶æ€æ—¥å¿—"
        else
          echo "âŒ æ— æ—¥å¿—æ–‡ä»¶"
        fi
