name: Deploy MCP Music Player Service

on:
  push:
    branches: [ main ]  # å½“ä»£ç æ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:    # æ”¯æŒæ‰‹åŠ¨è§¦å‘éƒ¨ç½²ï¼ˆåœ¨GitHub Actionsé¡µé¢ç‚¹å‡»è¿è¡Œï¼‰

jobs:
  deploy-service:
    runs-on: ubuntu-latest  # ä½¿ç”¨Ubuntu Runnerè¿è¡ŒæœåŠ¡

    steps:
      # ------------------- 1. æ‹‰å–ä»£ç  -------------------
      - name: Checkout Repository Code
        uses: actions/checkout@v4  # æ‹‰å–å½“å‰ä»“åº“ä»£ç 

      # ------------------- 2. è®¾ç½®Pythonç¯å¢ƒ -------------------
      - name: Set Up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"  # åŒ¹é…ä¾èµ–çš„Pythonç‰ˆæœ¬

      # ------------------- 3. å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆè§£å†³éŸ³é¢‘æ’­æ”¾é—®é¢˜ï¼‰ -------------------
      - name: Install GStreamer & Audio Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav  # è§£å†³playsoundçš„LinuxéŸ³é¢‘åç«¯ä¾èµ–

      # ------------------- 4. å‡çº§æ„å»ºå·¥å…· -------------------
      - name: Upgrade Build Tools
        run: |
          pip install --upgrade pip setuptools wheel

      # ------------------- 5. æ³¨å…¥ç¯å¢ƒå˜é‡ï¼ˆä»GitHub Secretsè¯»å–ï¼‰ -------------------
      - name: Inject Environment Variables
        run: |
          echo "MCP_WSS_TOKEN=${{ secrets.MCP_WSS_TOKEN }}" >> $GITHUB_ENV  # MCPæœåŠ¡è®¤è¯Tokenï¼ˆå¿…é¡»ï¼‰
          echo "MUSIC_API_KEY=${{ secrets.MUSIC_API_KEY }}" >> $GITHUB_ENV  # éŸ³ä¹API Keyï¼ˆå¯é€‰ï¼‰
          echo "LOG_LEVEL=INFO" >> $GITHUB_ENV  # æ—¥å¿—çº§åˆ«ï¼ˆå¯é€‰ï¼‰

      # ------------------- 6. å®‰è£…Pythonä¾èµ– -------------------
      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt  # å®‰è£…æ‰€æœ‰Pythonä¾èµ–

      # ------------------- 7. å¯åŠ¨MCPæœåŠ¡ -------------------
      - name: Start MCP Service
        id: start-service
        run: |
          # åå°è¿è¡ŒæœåŠ¡å¹¶é‡å®šå‘æ—¥å¿—
          nohup python music_player.py > music_player.log 2>&1 &
          # ç­‰å¾…æœåŠ¡åˆå§‹åŒ–
          sleep 10
          # æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
          if pgrep -f "python music_player.py" > /dev/null; then
            echo "âœ… MCPæœåŠ¡å·²æˆåŠŸå¯åŠ¨ï¼"
            echo "service-status=running" >> $GITHUB_OUTPUT
          else
            echo "âŒ MCPæœåŠ¡å¯åŠ¨å¤±è´¥ï¼"
            echo "service-status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ------------------- 8. ä¸Šä¼ æ—¥å¿—æ–‡ä»¶ï¼ˆä¾¿äºè°ƒè¯•ï¼‰ -------------------
      - name: Upload Service Logs
        uses: actions/upload-artifact@v4
        with:
          name: music-player-logs
          path: music_player.log
          if-no-files-found: ignore

      # ------------------- 9. ï¼ˆå¯é€‰ï¼‰éªŒè¯æœåŠ¡çŠ¶æ€ -------------------
      - name: Verify Service Health
        if: steps.start-service.outputs.service-status == 'running'
        run: |
          # æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰å¯åŠ¨æˆåŠŸçš„æ ‡è¯†
          if grep -q "ğŸš€ å¯åŠ¨æœåŠ¡ï¼Œè¿æ¥åˆ°MCPç«¯ç‚¹" music_player.log; then
            echo "ğŸŸ¢ æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
          else
            echo "ğŸ”´ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
            exit 1
          fi
