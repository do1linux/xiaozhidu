name: Music Service for Xiaozhi AI

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push: # ä»£ç æ¨é€æ—¶è§¦å‘
    branches: [ main ]
  schedule:
    # åœ¨åŒ—äº¬æ—¶é—´6ç‚¹å¯åŠ¨ï¼ˆUTC 22ç‚¹ï¼‰
    - cron: '0 22 * * *'
    # åœ¨åŒ—äº¬æ—¶é—´12ç‚¹å¯åŠ¨ï¼ˆUTC 4ç‚¹ï¼‰  
    - cron: '0 4 * * *'
    # åœ¨åŒ—äº¬æ—¶é—´18ç‚¹å¯åŠ¨ï¼ˆUTC 10ç‚¹ï¼‰
    - cron: '0 10 * * *'

env:
  MCP_ENDPOINT: ${{ secrets.MCP_ENDPOINT }}
  MUSIC_API_KEY: ${{ secrets.MUSIC_API_KEY }}

jobs:
  run-music-service:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # è®¾ç½®6å°æ—¶è¶…æ—¶ï¼Œç¡®ä¿ä¸ä¼šè¶…é™
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Check Beijing time and set runtime
      id: time_config
      run: |
        # è·å–UTCæ—¶é—´å¹¶è®¡ç®—åŒ—äº¬æ—¶é—´
        current_hour_utc=$(date -u +%H)
        current_hour_beijing=$(( (current_hour_utc + 8) % 24 ))
        
        echo "å½“å‰UTCæ—¶é—´: $(date -u)"
        echo "å½“å‰åŒ—äº¬æ—¶é—´: çº¦ $current_hour_beijing ç‚¹"
        
        # æ£€æŸ¥æ˜¯å¦åœ¨0-6ç‚¹ä¹‹é—´
        if [ $current_hour_beijing -ge 0 ] && [ $current_hour_beijing -lt 6 ]; then
          echo "å½“å‰ä¸ºåŒ—äº¬æ—¶é—´0-6ç‚¹ï¼Œè·³è¿‡æ‰§è¡Œ"
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "wait_seconds=0" >> $GITHUB_OUTPUT
        else
          echo "å½“å‰ä¸ºåŒ—äº¬æ—¶é—´6-24ç‚¹ï¼Œå¯åŠ¨æœåŠ¡"
          echo "should_run=true" >> $GITHUB_OUTPUT
          
          # è®¡ç®—è¿è¡Œæ—¶é—´ï¼ˆ5å°æ—¶50åˆ†é’Ÿ = 21000ç§’ï¼‰
          echo "wait_seconds=21000" >> $GITHUB_OUTPUT
        fi

    - name: Skip if in quiet hours
      if: steps.time_config.outputs.should_run == 'false'
      run: |
        echo "è·³è¿‡æœåŠ¡æ‰§è¡Œï¼Œå½“å‰ä¸ºé™é»˜æ—¶æ®µï¼ˆåŒ—äº¬æ—¶é—´0-6ç‚¹ï¼‰"
        exit 0

    - name: Start Music Service
      if: steps.time_config.outputs.should_run == 'true'
      run: |
        echo "å¯åŠ¨MusicæœåŠ¡è¿æ¥å°æ™ºAI..."
        echo "å¯åŠ¨æ—¶é—´: $(date)" > service_info.txt
        echo "é¢„è®¡è¿è¡Œ: 5å°æ—¶50åˆ†é’Ÿ" >> service_info.txt
        
        # å¯åŠ¨æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
        nohup python mcp_pipe.py music.py > service.log 2>&1 &
        echo $! > service.pid
        
        echo "âœ… MusicæœåŠ¡å·²å¯åŠ¨ï¼ŒPID: $(cat service.pid)"
        echo "ğŸ“¡ æ­£åœ¨è¿æ¥å°æ™ºAI MCPç«¯ç‚¹..."

    - name: Monitor and auto-restart
      if: steps.time_config.outputs.should_run == 'true'
      run: |
        WAIT_SECONDS=${{ steps.time_config.outputs.wait_seconds }}
        echo "â° æœåŠ¡å°†è¿è¡Œ $WAIT_SECONDS ç§’åè‡ªåŠ¨é‡å¯..."
        
        # ç­‰å¾…æŒ‡å®šæ—¶é—´
        sleep $WAIT_SECONDS
        
        echo "ğŸ”„ åˆ°è¾¾è‡ªåŠ¨é‡å¯æ—¶é—´ï¼Œåœæ­¢å½“å‰æœåŠ¡..."
        
        # åœæ­¢æœåŠ¡
        if [ -f service.pid ]; then
          echo "åœæ­¢è¿›ç¨‹: $(cat service.pid)"
          kill $(cat service.pid) 2>/dev/null || true
          rm -f service.pid
          echo "âœ… æœåŠ¡å·²åœæ­¢"
        fi
        
        echo "é‡å¯æ—¶é—´: $(date)" >> restart_log.txt
        echo "ğŸ” å‡†å¤‡é‡æ–°å¯åŠ¨..."

    - name: Trigger restart workflow
      if: steps.time_config.outputs.should_run == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'restart.yml',
              ref: 'main'
            });
            console.log('âœ… å·²è§¦å‘é‡å¯å·¥ä½œæµ');
          } catch (error) {
            console.log('âš ï¸ è§¦å‘é‡å¯å·¥ä½œæµå¤±è´¥ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œ');
          }

    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: service-logs-${{ github.run_id }}
        path: |
          service.log
          service_info.txt
          restart_log.txt
        retention-days: 3
