name: Deploy MCP Music Player Service  # å·¥ä½œæµåç§°

on:
  push:
    branches: [main]  # æ¨é€mainåˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘éƒ¨ç½²ï¼ˆåœ¨GitHub Actionsé¡µé¢ç‚¹å‡»è¿è¡Œï¼‰
    inputs:
      environment:
        description: "éƒ¨ç½²ç¯å¢ƒï¼ˆå¦‚ï¼šprod/testï¼‰"
        default: "prod"

jobs:
  deploy-mcp-service:
    runs-on: ubuntu-latest  # ä½¿ç”¨Ubuntu Runnerï¼ˆLinuxç¯å¢ƒï¼‰
    environment: ${{ github.event.inputs.environment || 'prod' }}  # å…³è”GitHubç¯å¢ƒï¼ˆå¯é€‰ï¼Œç”¨äº secrets ç®¡ç†ï¼‰
    steps:
      # ------------------- 1. æ‹‰å–ä»£ç  -------------------
      - name: Checkout Repository Code
        uses: actions/checkout@v4  # æ‹‰å–å½“å‰ä»“åº“ä»£ç 

      # ------------------- 2. è®¾ç½®Pythonç¯å¢ƒ -------------------
      - name: Set Up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"  # åŒ¹é…ä¾èµ–çš„Pythonç‰ˆæœ¬

      # ------------------- 3. å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆè§£å†³playsoundæ’­æ”¾é—®é¢˜ï¼‰ -------------------
      # playsoundä¾èµ–GStreamerå¤šåª’ä½“æ¡†æ¶ï¼ˆLinuxéŸ³é¢‘åç«¯ï¼‰
      - name: Install GStreamer & Audio Dependencies
        run: |
          sudo apt-get update -y  # æ›´æ–°åŒ…åˆ—è¡¨
          sudo apt-get install -y \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav  # å¿…é¡»ï¼šè§£å†³playsoundåœ¨Ubuntuä¸‹çš„å®‰è£…/æ’­æ”¾é”™è¯¯

      # ------------------- 4. å‡çº§æ„å»ºå·¥å…·ï¼ˆé¿å…pipç¼“å­˜é—®é¢˜ï¼‰ -------------------
      - name: Upgrade Build Tools
        run: |
          python -m pip install --upgrade pip setuptools wheel  # å‡çº§pipã€setuptoolsã€wheel

      # ------------------- 5. æ³¨å…¥ç¯å¢ƒå˜é‡ï¼ˆä»GitHub Secretsè¯»å–ï¼‰ -------------------
      # ä»ä»“åº“Settings â†’ Secrets and variables â†’ Actionsä¸­è¯»å–
      - name: Inject Environment Variables
        run: |
          echo "MCP_WSS_TOKEN=${{ secrets.MCP_WSS_TOKEN }}" >> $GITHUB_ENV  # MCPæœåŠ¡è®¤è¯Tokenï¼ˆå¿…é¡»ï¼‰
          echo "MUSIC_API_KEY=${{ secrets.MUSIC_API_KEY }}" >> $GITHUB_ENV  # éŸ³ä¹API Keyï¼ˆå¯é€‰ï¼Œè‹¥éœ€ï¼‰
          echo "LOG_LEVEL=INFO" >> $GITHUB_ENV  # æ—¥å¿—çº§åˆ«ï¼ˆå¯é€‰ï¼‰

      # ------------------- 6. å®‰è£…Pythonä¾èµ– -------------------
      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt  # å®‰è£…æ‰€æœ‰Pythonä¾èµ–ï¼ˆå«mcpã€playsoundç­‰ï¼‰

      # ------------------- 7. å¯åŠ¨MCPæœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰ -------------------
      - name: Start MCP Service
        id: start-service  # ç»™æ­¥éª¤å‘½åï¼Œæ–¹ä¾¿åç»­æ£€æŸ¥
        run: |
          # åå°è¿è¡ŒæœåŠ¡ï¼Œæ—¥å¿—è¾“å‡ºåˆ°music_player.log
          nohup python music_player.py > music_player.log 2>&1 &
          # ç­‰å¾…5ç§’ï¼Œè®©æœåŠ¡åˆå§‹åŒ–
          sleep 5
          # æ£€æŸ¥æœåŠ¡è¿›ç¨‹æ˜¯å¦å­˜æ´»
          if pgrep -f "python music_player.py" > /dev/null; then
            echo "âœ… MCPæœåŠ¡å·²æˆåŠŸå¯åŠ¨ï¼"
            echo "service-status=running" >> $GITHUB_OUTPUT  # è¾“å‡ºçŠ¶æ€ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          else
            echo "âŒ MCPæœåŠ¡å¯åŠ¨å¤±è´¥ï¼è¯·æŸ¥çœ‹æ—¥å¿—ï¼šmusic_player.log"
            echo "service-status=failed" >> $GITHUB_OUTPUT
            exit 1  # å¤±è´¥æ—¶ç»ˆæ­¢å·¥ä½œæµ
          fi

      # ------------------- 8. ï¼ˆå¯é€‰ï¼‰éªŒè¯æœåŠ¡çŠ¶æ€ -------------------
      - name: Verify Service Health
        if: steps.start-service.outputs.service-status == 'running'  # ä»…å½“æœåŠ¡å¯åŠ¨æˆåŠŸæ—¶æ‰§è¡Œ
        run: |
          # æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰â€œå¯åŠ¨æˆåŠŸâ€çš„æ ‡è¯†
          if grep -q "ğŸš€ å¯åŠ¨æœåŠ¡ï¼Œè¿æ¥åˆ°MCPç«¯ç‚¹" music_player.log; then
            echo "ğŸŸ¢ æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
          else
            echo "ğŸ”´ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
            exit 1
          fi
