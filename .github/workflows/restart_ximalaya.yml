name: Restart Ximalaya

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  repository_dispatch: # æ”¯æŒAPIè§¦å‘
    types: [restart-ximalaya-service]

env:
  MCP_ENDPOINT: ${{ secrets.MCP_ENDPOINT }}

jobs:
  auto-restart:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Check Beijing time
      id: time_check
      run: |
        current_hour_utc=$(date -u +%H)
        current_hour_beijing=$(( (current_hour_utc + 8) % 24 ))
        
        echo "å½“å‰UTCæ—¶é—´: $(date -u)"
        echo "å½“å‰åŒ—äº¬æ—¶é—´: çº¦ $current_hour_beijing ç‚¹"
        
        if [ $current_hour_beijing -ge 0 ] && [ $current_hour_beijing -lt 6 ]; then
          echo "should_run=false" >> $GITHUB_OUTPUT
        else
          echo "should_run=true" >> $GITHUB_OUTPUT
        fi

    - name: Skip restart in quiet hours
      if: steps.time_check.outputs.should_run == 'false'
      run: |
        echo "ğŸŒ™ å½“å‰ä¸ºé™é»˜æ—¶æ®µï¼ˆåŒ—äº¬æ—¶é—´0-6ç‚¹ï¼‰ï¼Œè·³è¿‡å¬ä¹¦æœåŠ¡é‡å¯"
        exit 0

    - name: Stop any existing Ximalaya
      if: steps.time_check.outputs.should_run == 'true'
      run: |
        echo "ğŸ›‘ åœæ­¢å¯èƒ½å­˜åœ¨çš„å¬ä¹¦æœåŠ¡è¿›ç¨‹..."
        # æŸ¥æ‰¾å¹¶åœæ­¢ximalayaæœåŠ¡ç›¸å…³è¿›ç¨‹
        pkill -f "mcp_pipe.py ximalaya.py" || true
        sleep 2
        echo "âœ… å¬ä¹¦æœåŠ¡æ¸…ç†å®Œæˆ"

    - name: Start new Ximalaya instance
      if: steps.time_check.outputs.should_run == 'true'
      run: |
        echo "ğŸš€ å¯åŠ¨æ–°çš„å¬ä¹¦æœåŠ¡å®ä¾‹..."
        echo "å¬ä¹¦æœåŠ¡é‡å¯æ—¶é—´: $(date)" > ximalaya_restart_info.txt
        
        # å¯åŠ¨æ–°å®ä¾‹
        nohup python mcp_pipe.py ximalaya.py > ximalaya_service_restart.log 2>&1 &
        echo $! > ximalaya_service_restart.pid
        
        echo "âœ… æ–°å¬ä¹¦æœåŠ¡å®ä¾‹å·²å¯åŠ¨ï¼ŒPID: $(cat ximalaya_service_restart.pid)"
        echo "ğŸ“¡ é‡æ–°è¿æ¥å°æ™ºAIå¬ä¹¦æœåŠ¡..."

    - name: Wait and monitor Ximalaya
      if: steps.time_check.outputs.should_run == 'true'
      run: |
        echo "â° å¬ä¹¦æœåŠ¡å°†è¿è¡Œ5å°æ—¶50åˆ†é’Ÿ..."
        
        # ç­‰å¾…5å°æ—¶50åˆ†é’Ÿ (21000ç§’)
        sleep 21000
        
        echo "ğŸ”„ å¬ä¹¦æœåŠ¡åˆ°è¾¾é‡å¯æ—¶é—´ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡é‡å¯..."
        
        # è®°å½•é‡å¯ä¿¡æ¯
        echo "è®¡åˆ’é‡å¯æ—¶é—´: $(date)" >> ximalaya_restart_log.txt

    - name: Trigger next restart cycle
      if: steps.time_check.outputs.should_run == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'restart_ximalaya.yml',
              ref: 'main'
            });
            console.log('âœ… å·²è§¦å‘å¬ä¹¦æœåŠ¡ä¸‹ä¸€æ¬¡é‡å¯å·¥ä½œæµ');
          } catch (error) {
            console.log('âš ï¸ è§¦å‘å¬ä¹¦æœåŠ¡é‡å¯å·¥ä½œæµå¤±è´¥: ' + error.message);
          }

    - name: Upload Ximalaya restart logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ximalaya-restart-logs-${{ github.run_id }}
        path: |
          ximalaya_service_restart.log
          ximalaya_restart_info.txt
          ximalaya_restart_log.txt
        retention-days: 3
