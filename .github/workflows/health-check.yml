name: Health Check and Recovery for Both Services

on:
  schedule:
    # 每30分钟检查一次健康状态
    - cron: '*/30 * * * *'
  workflow_dispatch:

env:
  MCP_ENDPOINT: ${{ secrets.MCP_ENDPOINT }}
  MUSIC_API_KEY: ${{ secrets.MUSIC_API_KEY }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check Beijing time
      id: time_check
      run: |
        current_hour_utc=$(date -u +%H)
        current_hour_beijing=$(( (current_hour_utc + 8) % 24 ))
        
        if [ $current_hour_beijing -ge 0 ] && [ $current_hour_beijing -lt 6 ]; then
          echo "should_check=false" >> $GITHUB_OUTPUT
        else
          echo "should_check=true" >> $GITHUB_OUTPUT
        fi

    - name: Skip health check in quiet hours
      if: steps.time_check.outputs.should_check == 'false'
      run: echo "🌙 静默时段（北京时间0-6点），跳过健康检查"

    - name: Checkout code and setup environment
      if: steps.time_check.outputs.should_check == 'true'
      uses: actions/checkout@v4

    - name: Setup Python
      if: steps.time_check.outputs.should_check == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      if: steps.time_check.outputs.should_check == 'true'
      run: pip install -r requirements.txt

    - name: Check Music Service status
      if: steps.time_check.outputs.should_check == 'true'
      id: music_status
      run: |
        echo "🔍 检查Music服务状态..."
        
        # 检查音乐服务进程是否在运行
        if pgrep -f "mcp_pipe.py music.py" > /dev/null; then
          echo "✅ Music服务进程正在运行"
          echo "music_needs_restart=false" >> $GITHUB_OUTPUT
        else
          echo "❌ Music服务进程未运行"
          echo "music_needs_restart=true" >> $GITHUB_OUTPUT
        fi

    - name: Check Ximalaya Service status
      if: steps.time_check.outputs.should_check == 'true'
      id: ximalaya_status
      run: |
        echo "🔍 检查Ximalaya听书服务状态..."
        
        # 检查听书服务进程是否在运行
        if pgrep -f "mcp_pipe.py ximalaya.py" > /dev/null; then
          echo "✅ Ximalaya服务进程正在运行"
          echo "ximalaya_needs_restart=false" >> $GITHUB_OUTPUT
        else
          echo "❌ Ximalaya服务进程未运行"
          echo "ximalaya_needs_restart=true" >> $GITHUB_OUTPUT
        fi

    - name: Trigger Music service restart if unhealthy
      if: steps.music_status.outputs.music_needs_restart == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'restart.yml',
              ref: 'main'
            });
            console.log('🔄 检测到Music服务异常，已触发重启');
          } catch (error) {
            console.log('⚠️ 触发Music服务重启工作流失败: ' + error.message);
          }

    - name: Trigger Ximalaya service restart if unhealthy
      if: steps.ximalaya_status.outputs.ximalaya_needs_restart == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'restart_ximalaya.yml',
              ref: 'main'
            });
            console.log('🔄 检测到Ximalaya服务异常，已触发重启');
          } catch (error) {
            console.log('⚠️ 触发Ximalaya服务重启工作流失败: ' + error.message);
          }

    - name: Log health status
      if: steps.time_check.outputs.should_check == 'true'
      run: |
        echo "📊 健康检查汇总:"
        echo "Music服务状态: ${{ steps.music_status.outputs.music_needs_restart == 'true' && '异常' || '正常' }}"
        echo "Ximalaya服务状态: ${{ steps.ximalaya_status.outputs.ximalaya_needs_restart == 'true' && '异常' || '正常' }}"
        echo "检查时间: $(date)"
