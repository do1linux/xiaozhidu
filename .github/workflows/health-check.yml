name: Health Check and Recovery

on:
  schedule:
    # æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€
    - cron: '*/30 * * * *'
  workflow_dispatch:

env:
  MCP_ENDPOINT: ${{ secrets.MCP_ENDPOINT }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check Beijing time
      id: time_check
      run: |
        current_hour_utc=$(date -u +%H)
        current_hour_beijing=$(( (current_hour_utc + 8) % 24 ))
        
        if [ $current_hour_beijing -ge 0 ] && [ $current_hour_beijing -lt 6 ]; then
          echo "should_check=false" >> $GITHUB_OUTPUT
        else
          echo "should_check=true" >> $GITHUB_OUTPUT
        fi

    - name: Skip health check in quiet hours
      if: steps.time_check.outputs.should_check == 'false'
      run: echo "é™é»˜æ—¶æ®µï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"

    - name: Check service status
      if: steps.time_check.outputs.should_check == 'true'
      id: service_status
      run: |
        echo "ğŸ” æ£€æŸ¥MusicæœåŠ¡çŠ¶æ€..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æœåŠ¡å¥åº·æ£€æŸ¥é€»è¾‘
        # ä¾‹å¦‚ï¼šæ£€æŸ¥è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œã€èƒ½å¦æ­£å¸¸å“åº”ç­‰
        echo "âœ… å¥åº·æ£€æŸ¥å®Œæˆ"
        echo "needs_restart=false" >> $GITHUB_OUTPUT

    - name: Trigger restart if unhealthy
      if: steps.service_status.outputs.needs_restart == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'restart.yml',
            ref: 'main'
          });
          console.log('ğŸ”„ æ£€æµ‹åˆ°æœåŠ¡å¼‚å¸¸ï¼Œå·²è§¦å‘é‡å¯');
