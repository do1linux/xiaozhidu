name: Health Check and Recovery for Both Services

on:
  schedule:
    # æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€
    - cron: '*/30 * * * *'
  workflow_dispatch:

env:
  MCP_ENDPOINT: ${{ secrets.MCP_ENDPOINT }}
  MUSIC_API_KEY: ${{ secrets.MUSIC_API_KEY }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check Beijing time
      id: time_check
      run: |
        current_hour_utc=$(date -u +%H)
        current_hour_beijing=$(( (current_hour_utc + 8) % 24 ))
        
        if [ $current_hour_beijing -ge 0 ] && [ $current_hour_beijing -lt 6 ]; then
          echo "should_check=false" >> $GITHUB_OUTPUT
        else
          echo "should_check=true" >> $GITHUB_OUTPUT
        fi

    - name: Skip health check in quiet hours
      if: steps.time_check.outputs.should_check == 'false'
      run: echo "ğŸŒ™ é™é»˜æ—¶æ®µï¼ˆåŒ—äº¬æ—¶é—´0-6ç‚¹ï¼‰ï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"

    - name: Checkout code and setup environment
      if: steps.time_check.outputs.should_check == 'true'
      uses: actions/checkout@v4

    - name: Setup Python
      if: steps.time_check.outputs.should_check == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      if: steps.time_check.outputs.should_check == 'true'
      run: pip install -r requirements.txt

    - name: Check Music Service status
      if: steps.time_check.outputs.should_check == 'true'
      id: music_status
      run: |
        echo "ğŸ” æ£€æŸ¥MusicæœåŠ¡çŠ¶æ€..."
        
        # æ£€æŸ¥éŸ³ä¹æœåŠ¡è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ
        if pgrep -f "mcp_pipe.py music.py" > /dev/null; then
          echo "âœ… MusicæœåŠ¡è¿›ç¨‹æ­£åœ¨è¿è¡Œ"
          echo "music_needs_restart=false" >> $GITHUB_OUTPUT
        else
          echo "âŒ MusicæœåŠ¡è¿›ç¨‹æœªè¿è¡Œ"
          echo "music_needs_restart=true" >> $GITHUB_OUTPUT
        fi

    - name: Check Ximalaya Service status
      if: steps.time_check.outputs.should_check == 'true'
      id: ximalaya_status
      run: |
        echo "ğŸ” æ£€æŸ¥Ximalayaå¬ä¹¦æœåŠ¡çŠ¶æ€..."
        
        # æ£€æŸ¥å¬ä¹¦æœåŠ¡è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ
        if pgrep -f "mcp_pipe.py ximalaya.py" > /dev/null; then
          echo "âœ… XimalayaæœåŠ¡è¿›ç¨‹æ­£åœ¨è¿è¡Œ"
          echo "ximalaya_needs_restart=false" >> $GITHUB_OUTPUT
        else
          echo "âŒ XimalayaæœåŠ¡è¿›ç¨‹æœªè¿è¡Œ"
          echo "ximalaya_needs_restart=true" >> $GITHUB_OUTPUT
        fi

    - name: Trigger Music service restart if unhealthy
      if: steps.music_status.outputs.music_needs_restart == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'restart.yml',
              ref: 'main'
            });
            console.log('ğŸ”„ æ£€æµ‹åˆ°MusicæœåŠ¡å¼‚å¸¸ï¼Œå·²è§¦å‘é‡å¯');
          } catch (error) {
            console.log('âš ï¸ è§¦å‘MusicæœåŠ¡é‡å¯å·¥ä½œæµå¤±è´¥: ' + error.message);
          }

    - name: Trigger Ximalaya service restart if unhealthy
      if: steps.ximalaya_status.outputs.ximalaya_needs_restart == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'restart_ximalaya.yml',
              ref: 'main'
            });
            console.log('ğŸ”„ æ£€æµ‹åˆ°XimalayaæœåŠ¡å¼‚å¸¸ï¼Œå·²è§¦å‘é‡å¯');
          } catch (error) {
            console.log('âš ï¸ è§¦å‘XimalayaæœåŠ¡é‡å¯å·¥ä½œæµå¤±è´¥: ' + error.message);
          }

    - name: Log health status
      if: steps.time_check.outputs.should_check == 'true'
      run: |
        echo "ğŸ“Š å¥åº·æ£€æŸ¥æ±‡æ€»:"
        echo "MusicæœåŠ¡çŠ¶æ€: ${{ steps.music_status.outputs.music_needs_restart == 'true' && 'å¼‚å¸¸' || 'æ­£å¸¸' }}"
        echo "XimalayaæœåŠ¡çŠ¶æ€: ${{ steps.ximalaya_status.outputs.ximalaya_needs_restart == 'true' && 'å¼‚å¸¸' || 'æ­£å¸¸' }}"
        echo "æ£€æŸ¥æ—¶é—´: $(date)"
